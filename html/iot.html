<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AgriDoot - IoT Device</title>

    <link rel="icon" type="image/x-icon" href="/img/agfav.ico" />

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #16a34a;
        --bg: #f8fafc;
        --panel: #ffffff;
        --border: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont;
        background: var(--bg);
        color: var(--text);
      }

      /* ====== Core UI ====== */
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04),
          0 8px 24px rgba(0, 0, 0, 0.04);
      }

      .input {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 0.55rem 0.7rem;
        font-size: 0.875rem;
        background: #fff;
      }

      .input:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.15);
      }

      .label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 4px;
        display: block;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.55rem 0.9rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: var(--brand);
        color: #fff;
      }

      .btn-primary:hover {
        background: #15803d;
        box-shadow: 0 6px 18px rgba(22, 163, 74, 0.25);
      }

      .btn-outline {
        background: #fff;
        border: 1px solid var(--border);
        color: var(--text);
      }

      .btn-outline:hover {
        background: #f8fafc;
      }

      /* ====== Header ====== */
      header {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border);
      }

      /* ====== Tables ====== */
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      thead th {
        position: sticky;
        top: 0;
        background: #f9fafb;
        font-size: 0.7rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--muted);
        border-bottom: 1px solid var(--border);
      }

      td,
      th {
        padding: 0.55rem 0.7rem;
        border-bottom: 1px solid var(--border);
        font-size: 0.8rem;
        white-space: nowrap;
      }

      tbody tr:hover {
        background: #f8fafc;
      }

      /* ====== Status Pills ====== */
      .pill {
        padding: 0.15rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 999px;
        background: #ecfdf5;
        color: #047857;
      }

      /* ====== Animations ====== */
      .fade {
        animation: fadeUp 0.3s ease-out;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      button.cursor-not-allowed {
        background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
      }
    </style>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>

  <body
    class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-emerald-50"
  >
    <!-- Header -->
    <header
      class="sticky top-0 z-30 backdrop-blur bg-white/70 border-b border-emerald-100"
    >
      <div class="mx-auto max-w-7xl px-4 md:px-6">
        <div class="flex h-16 items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="h-9 w-9 grid place-items-center rounded-xl bg-emerald-600 text-white font-bold"
            >
              AD
            </div>
            <div>
              <h1 class="text-lg font-semibold tracking-tight">
                AgriDoot ‚Äî Device Admin
              </h1>
              <p class="text-xs text-gray-500 -mt-0.5">
                Register & Manage Devices
              </p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div
              id="authStatus"
              class="hidden md:flex items-center gap-3"
            ></div>
            <div id="g_id_signin"></div>
            <button id="signOutBtn" class="btn btn-outline hidden">
              Sign out
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Global Alert (e.g., show any 207 messages here) -->
    <div
      id="globalAlert"
      class="mx-auto max-w-7xl px-4 md:px-6 mt-4 hidden"
    ></div>

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-4 md:px-6 py-8 space-y-8">
      <!-- Auth gates -->
      <div id="authGate" class="card p-6 border border-emerald-100 hidden">
        <div class="flex items-start gap-4">
          <div
            class="h-10 w-10 grid place-items-center rounded-2xl bg-emerald-100 text-emerald-700"
          >
            üîê
          </div>
          <div>
            <h2 class="text-lg font-semibold">Sign in required</h2>
            <p class="text-gray-600 mt-1">
              Use Google Sign‚ÄëIn to access registration and the device list.
              Your session stays active for 8 hours.
            </p>
          </div>
        </div>
      </div>

      <div id="unauthGate" class="card p-6 border border-red-200 hidden">
        <div class="flex items-start gap-4">
          <div
            class="h-10 w-10 grid place-items-center rounded-2xl bg-red-100 text-red-700"
          >
            ‚õî
          </div>
          <div>
            <h2 class="text-lg font-semibold text-red-700">
              Don't Authorize to access
            </h2>
            <p class="text-gray-600 mt-1">
              Kindly contact your admin to get access.
            </p>
          </div>
        </div>
      </div>

      <!-- App content (stacked sections) -->
      <div id="appContent" class="space-y-6 hidden">
        <!-- Registration Card -->
        <section class="card p-8 mx-auto max-w-3xl" id="registerCard">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-center w-full">
              Register New Device
            </h2>
          </div>
          <form id="regForm" class="space-y-4">
            <div>
              <label class="label">Device type</label>
              <select name="dev_type" class="input" required>
                <option value="" disabled selected>Select type</option>
                <option value="pod">pod</option>
                <option value="pro">pro</option>
              </select>
            </div>
            <div>
              <label class="label">IMEI number</label>
              <input
                name="imei"
                type="text"
                inputmode="numeric"
                pattern="[0-9]{14,16}"
                minlength="14"
                maxlength="16"
                placeholder="15‚Äëdigit IMEI"
                class="input"
                required
              />
              <p class="text-xs text-gray-500 mt-1">14‚Äì16 digits. No spaces.</p>
            </div>
            <div>
              <label class="label">SIM type</label>
              <select name="sim_type" class="input" required>
                <option value="" disabled selected>Select SIM</option>
                <option value="Airtel">Airtel</option>
                <option value="Jio">Jio</option>
                <option value="VI">VI</option>
              </select>
            </div>
            <div>
              <label class="label">SIM number</label>
              <input
                name="sim_no"
                type="text"
                inputmode="numeric"
                pattern="[0-9]{10,20}"
                placeholder="SIM number"
                class="input"
                required
              />
            </div>
            <div>
              <label class="label">Mobile number</label>
              <input
                name="mob_no"
                type="text"
                inputmode="tel"
                pattern="[0-9]{10}"
                maxlength="10"
                placeholder="10‚Äëdigit mobile"
                class="input"
                required
              />
            </div>
            <div>
              <label class="label">Created by</label>
              <input
                name="created_by"
                type="text"
                placeholder="Your name or ID"
                class="input"
                required
              />
            </div>
            <div class="flex items-center justify-between pt-4">
              <button type="reset" class="btn btn-outline">Reset</button>
              <button id="submitBtn" type="submit" class="btn btn-primary">
                Register
              </button>
            </div>
          </form>
          <div id="regToast" class="mt-4 hidden"></div>
        </section>

        <!-- List Card -->
        <section class="card p-6" id="listCard">
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4"
          >
            <div>
              <h2 class="text-xl font-semibold">View all devices</h2>
              <p class="text-sm text-gray-500">
                Search by serial number. Leave empty to view all.
              </p>
            </div>
            <div class="flex items-center gap-2">
              <input
                id="searchSerial"
                class="input w-64"
                placeholder="Search serial_no..."
              />
              <button id="searchBtn" class="btn btn-outline">Search</button>
              <button id="refreshBtn" class="btn btn-primary">Refresh</button>
            </div>
          </div>

          <div class="overflow-auto border border-gray-200 rounded-2xl">
            <table class="min-w-full table" id="deviceTable">
              <thead class="bg-gray-50">
                <tr id="deviceThead"></tr>
              </thead>
              <tbody
                id="deviceTbody"
                class="divide-y divide-gray-100 bg-white"
              ></tbody>
            </table>
          </div>
          <div
            id="listEmpty"
            class="text-center text-gray-500 text-sm py-6 hidden"
          >
            No devices found.
          </div>
        </section>

        <!-- Device Search by Phone -->
        <section class="card p-6 max-w-4xl mx-auto">
          <h2 class="text-xl font-semibold mb-4">MQTT Device Data</h2>

          <div class="grid md:grid-cols-5 gap-3">
            <div>
              <label class="label">Phone Number</label>
              <input
                id="phoneInput"
                class="input"
                placeholder="10-digit mobile"
              />
            </div>

            <div>
              <label class="label">From Date</label>
              <input id="fromDate" type="datetime-local" class="input" />
            </div>

            <div>
              <label class="label">To Date</label>
              <input id="toDate" type="datetime-local" class="input" />
            </div>

            <div>
              <label class="label">Page</label>
              <input
                id="pageInput"
                type="number"
                value="1"
                min="1"
                class="input"
              />
            </div>

            <div>
              <label class="label">Per Page</label>
              <input
                id="perPageInput"
                type="number"
                value="100"
                min="1"
                max="5000"
                class="input"
              />
            </div>
          </div>

          <div class="flex justify-end mt-4">
            <button id="fetchByPhoneBtn" class="btn btn-primary">
              Fetch Data
            </button>
          </div>

          <div id="phoneError" class="text-red-600 text-sm mt-3 hidden"></div>

          <div class="flex items-center justify-end gap-3 mt-4">
            <button id="prevPageBtn" class="btn btn-outline" disabled>
              ‚èÆ Previous
            </button>

            <span class="text-sm text-gray-600">
              Page <b id="currentPageLabel">1</b>
            </span>

            <button id="nextPageBtn" class="btn btn-primary">Next ‚è≠</button>
          </div>
          <div class="card p-4 mt-6">
            <div class="grid md:grid-cols-4 gap-3 items-end">
              <div>
                <label class="label">Select Field</label>
                <select id="graphField" class="input">
                  <option value="atm_temp">Atmospheric Temperature</option>
                  <option value="atm_humid">Atmospheric Humidity</option>
                  <option value="atm_pressure">Atmospheric Pressure</option>
                  <option value="battery">Battery</option>
                  <option value="leaf">Leaf Wetness</option>
                  <option value="lux">Lux</option>
                  <option value="nitrogen">Nitrogen</option>
                  <option value="phosphorus">Phosphorus</option>
                  <option value="potassium">Potassium</option>
                  <option value="rain">Rain</option>
                  <option value="s_dew">Soil Dew</option>
                  <option value="s_hum">Soil Moisture</option>
                  <option value="s_temp">Soil Temperature</option>
                  <option value="u_moist">Root Moisture</option>
                  <option value="u_temp">Root Temperature</option>
                  <option value="u_con">Electric Conductivity</option>
                  <option value="u_ph">pH</option>
                  <option value="uv">UV Index</option>
                  <option value="wind_spped">Wind Speed</option>
                </select>
              </div>

              <button id="loadGraphBtn" class="btn btn-primary">
                üìà Load Graph
              </button>

              <button id="exportCsvBtn" class="btn btn-outline">
                üì• Export Data
              </button>
            </div>

            <div class="mt-6">
              <canvas id="deviceChart" height="120"></canvas>
            </div>
          </div>
        </section>

        <!-- Device Info Card -->
        <section id="deviceInfoCard" class="card p-6 max-w-4xl mx-auto hidden">
          <h3 class="text-lg font-semibold mb-3">Device Information</h3>
          <div class="grid md:grid-cols-2 gap-3 text-sm">
            <div><b>Dev ID:</b> <span id="di_dev_id"></span></div>
            <div><b>Type:</b> <span id="di_type"></span></div>
            <div><b>IMEI:</b> <span id="di_imei"></span></div>
            <div><b>Serial:</b> <span id="di_serial"></span></div>
            <div>
              <b>Location:</b>
              <a id="di_map" target="_blank" class="text-emerald-600 underline">
                View on Map
              </a>
            </div>
          </div>
        </section>

        <!-- Device Data Table -->
        <section id="deviceDataCard" class="card p-6 max-w-7xl mx-auto hidden">
          <h3 class="text-lg font-semibold mb-4">Device Data</h3>

          <div class="overflow-auto border rounded-xl">
            <table class="min-w-full table">
              <thead class="bg-gray-50">
                <tr id="dataThead"></tr>
              </thead>
              <tbody id="dataTbody" class="divide-y"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <footer class="py-8 text-center text-sm text-gray-500">
      Built with ‚ù§Ô∏è for AgriDoot ‚Ä¢
      <span class="brand font-semibold">Secure ¬∑ Fast ¬∑ Minimal</span>
    </footer>

    <script>
      // Global vars
      let ALL_DEVICE_DATA = [];
      let deviceChartInstance = null;

      /*************************
       * Config ‚Äî EDIT THESE
       *************************/
      const GOOGLE_CLIENT_ID =
        "720727892020-rtfm0ej4t214f04kejpuqbovii6nb95f.apps.googleusercontent.com"; // ‚Üê replace
      const API_BASE = "https://api.novosedge.xyz:4433/ad/dev";
      // Whitelist: either provide a file named
      //   ./whitelist.json  -> ["allowed@mail.com", ...]
      // or edit the fallback array below.
      const FALLBACK_WHITELIST = ["shashwatraj98765@gmail.com", "agridoot.novosedge@gmail.com"]; // ‚Üê change or leave empty if using file

      /*************************
       * Utilities
       *************************/
      const qs = (s, el = document) => el.querySelector(s);
      const qsa = (s, el = document) => Array.from(el.querySelectorAll(s));

      (function autoFillDates() {
        const now = new Date();
        const past = new Date(now.getTime() - 24 * 60 * 60 * 1000);

        qs("#toDate").value = now.toISOString().slice(0, 16);
        qs("#fromDate").value = past.toISOString().slice(0, 16);
      })();

      function showToast(el, type, msg) {
        el.className =
          "mt-4 p-3 rounded-xl text-sm" +
          (type === "ok"
            ? " bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200"
            : " bg-red-50 text-red-700 ring-1 ring-red-200");
        el.textContent = msg;
        el.classList.remove("hidden");
      }
      function showGlobal(type, msg) {
        const el = qs("#globalAlert");
        el.className = "mx-auto max-w-7xl px-4 md:px-6 mt-4";
        const box = document.createElement("div");
        box.className =
          (type === "ok"
            ? "bg-emerald-50 text-emerald-700 ring-emerald-200"
            : "bg-amber-50 text-amber-800 ring-amber-200") +
          " ring-1 rounded-2xl px-4 py-3";
        box.textContent = msg;
        el.innerHTML = "";
        el.appendChild(box);
        el.classList.remove("hidden");
      }
      function clearGlobal() {
        qs("#globalAlert").classList.add("hidden");
      }

      function setLoading(btn, loading = true, labelWhenDone) {
        if (!btn) return;
        if (loading) {
          btn.dataset.orig = btn.textContent;
          btn.disabled = true;
          btn.innerHTML =
            '<svg class="animate-spin h-5 w-5 mr-2 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>Working...';
        } else {
          btn.disabled = false;
          btn.textContent = labelWhenDone || btn.dataset.orig || "Submit";
        }
      }
      function humanDate(ts) {
        try {
          return ts ? new Date(ts).toLocaleString() : "";
        } catch {
          return ts || "";
        }
      }

      /*************************
       * Auth ‚Äî Google + Whitelist
       *************************/
      const SESSION_KEY = "ag_auth"; // { id, name, email, picture, exp, id_token }
      const WL_KEY = "ag_wl";

      function isSessionActive() {
        const raw = localStorage.getItem(SESSION_KEY);
        if (!raw) return false;
        try {
          const s = JSON.parse(raw);
          return s.exp && Date.now() < s.exp;
        } catch {
          return false;
        }
      }
      function getSession() {
        try {
          return JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
        } catch {
          return null;
        }
      }
      function saveSession(profile) {
        profile.exp = Date.now() + 8 * 60 * 60 * 1000;
        localStorage.setItem(SESSION_KEY, JSON.stringify(profile));
        renderAuthUI();
      }
      function clearSession() {
        localStorage.removeItem(SESSION_KEY);
        renderAuthUI();
      }

      async function fetchAllDeviceData(params) {
        let page = 1;
        let allData = [];
        let hasMore = true;

        while (hasMore) {
          const resp = await apiGetDeviceData({
            ...params,
            page,
          });

          const rows = resp.devData || [];
          allData = allData.concat(rows);

          if (!rows.length || !resp.pageInfo?.next) {
            hasMore = false;
          } else {
            page++;
          }
        }

        return allData;
      }

      async function loadWhitelist() {
        // try cache
        const cached = localStorage.getItem(WL_KEY);
        if (cached) {
          try {
            return JSON.parse(cached);
          } catch {}
        }
        try {
          const res = await fetch("whitelist.json", { cache: "no-store" });
          if (res.ok) {
            const list = await res.json();
            if (Array.isArray(list)) {
              localStorage.setItem(WL_KEY, JSON.stringify(list));
              return list;
            }
          }
        } catch {}
        // fallback
        return FALLBACK_WHITELIST;
      }

      function renderAuthUI() {
        const gate = qs("#authGate");
        const unauth = qs("#unauthGate");
        const app = qs("#appContent");
        const authStatus = qs("#authStatus");
        const signOutBtn = qs("#signOutBtn");
        const gSignIn = qs("#g_id_signin");

        const active = isSessionActive();
        const session = getSession();

        // Default states
        gate.classList.toggle("hidden", active);
        signOutBtn.classList.toggle("hidden", !active);
        authStatus.classList.toggle("hidden", !active);
        gSignIn.classList.toggle("hidden", active);

        // Check whitelist when active
        if (active && session?.email) {
          loadWhitelist().then((list) => {
            const allowed =
              Array.isArray(list) &&
              list
                .map((e) => (e || "").toLowerCase().trim())
                .includes(session.email.toLowerCase());
            unauth.classList.toggle("hidden", allowed);
            app.classList.toggle("hidden", !allowed);
          });
        } else {
          app.classList.add("hidden");
          unauth.classList.add("hidden");
        }

        if (active && session) {
          authStatus.innerHTML = `
          <img src="${session.picture}" class="h-8 w-8 rounded-xl" alt="user"/>
          <div class="leading-tight">
            <div class="text-sm font-semibold">${session.name}</div>
            <div class="text-xs text-gray-500">${
              session.email
            } ‚Ä¢ expires ${new Date(session.exp).toLocaleTimeString()}</div>
          </div>`;
        } else {
          authStatus.innerHTML = "";
        }
      }

      window.onload = () => {
        renderAuthUI();
        if (window.google && google.accounts) {
          google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: async (response) => {
              try {
                const id_token = response.credential;
                const payload = JSON.parse(atob(id_token.split(".")[1]));
                saveSession({
                  id: payload.sub,
                  name: payload.name,
                  email: payload.email,
                  picture: payload.picture,
                  id_token,
                });
                await loadDeviceList();
              } catch (e) {
                console.error(e);
                alert("Failed to sign in.");
              }
            },
            auto_select: false,
            ux_mode: "popup",
          });
          google.accounts.id.renderButton(qs("#g_id_signin"), {
            theme: "outline",
            size: "large",
            shape: "pill",
            width: 200,
          });
          google.accounts.id.prompt();
        }
      };

      qs("#signOutBtn").addEventListener("click", clearSession);

      /*************************
       * UI ‚Äî Device fetch by phone
       *************************/
      async function handleFetchByPhone() {
        clearGlobal();

        const phone = qs("#phoneInput").value.trim();
        const fromDate = qs("#fromDate").value.replace("T", " ");
        const toDate = qs("#toDate").value.replace("T", " ");
        const page = qs("#pageInput").value || 1;
        updatePageUI(Number(page));
        const perPage = qs("#perPageInput").value || 100;

        if (!/^[0-9]{10}$/.test(phone)) {
          showGlobal("warn", "Please enter a valid 10-digit phone number");
          return;
        }

        try {
          /* STEP 1: PHONE ‚Üí DEVICE INFO */
          const userResp = await apiGetDeviceByPhone(phone);

          const deviceInfo = userResp?.userDetails?.DeviceInfo;
          if (!deviceInfo) {
            showGlobal("warn", "No device mapped to this phone number");
            return;
          }

          const { dev_id, dev_type, imei, serial_no, dev_lat, dev_lon } =
            deviceInfo;

          /* SHOW BASIC DEVICE INFO */
          qs("#deviceInfoCard").classList.remove("hidden");
          qs("#di_dev_id").textContent = dev_id;
          qs("#di_type").textContent = dev_type;
          qs("#di_imei").textContent = imei;
          qs("#di_serial").textContent = serial_no;
          qs(
            "#di_map"
          ).href = `https://www.google.com/maps?q=${dev_lat},${dev_lon}`;

          /* STEP 2: FETCH DEVICE DATA */
          const dataResp = await apiGetDeviceData({
            dev_id,
            from_date: fromDate,
            to_date: toDate,
            page,
            per_page: perPage,
          });

          renderDeviceDataTable(dataResp.devData || []);
          qs("#deviceDataCard").classList.remove("hidden");
        } catch (err) {
          console.error(err);
          showGlobal("warn", err.message || "Failed to fetch device data");
        }
      }

      /*************************
       * Pagination Controls
       *************************/
      function updatePageUI(page) {
        qs("#currentPageLabel").textContent = page;
        qs("#prevPageBtn").disabled = page <= 1;
      }

      qs("#nextPageBtn")?.addEventListener("click", () => {
        const pageInput = qs("#pageInput");
        pageInput.value = Number(pageInput.value || 1) + 1;
        updatePageUI(pageInput.value);
        handleFetchByPhone();
      });

      qs("#prevPageBtn")?.addEventListener("click", () => {
        const pageInput = qs("#pageInput");
        const p = Math.max(1, Number(pageInput.value || 1) - 1);
        pageInput.value = p;
        updatePageUI(p);
        handleFetchByPhone();
      });

      /*************************
       * Graph rendering
       *************************/
      qs("#loadGraphBtn")?.addEventListener("click", async () => {
        const btn = qs("#loadGraphBtn");
        const field = qs("#graphField").value;
        const dev_id = qs("#di_dev_id").textContent;

        if (!dev_id) {
          showGlobal("warn", "Load device first");
          return;
        }
        if (!field) {
          showGlobal("warn", "Please select a field");
          return;
        }

        setLoading(btn, true, "üìà Load Graph");

        try {
          showGlobal("ok", "Loading graph data from all pages...");

          ALL_DEVICE_DATA = await fetchAllDeviceData({
            dev_id,
            from_date: qs("#fromDate").value.replace("T", " "),
            to_date: qs("#toDate").value.replace("T", " "),
            per_page: qs("#perPageInput").value || 100,
          });

          if (!ALL_DEVICE_DATA.length) {
            showGlobal("warn", "No data available for graph");
            return;
          }

          renderGraph(field, ALL_DEVICE_DATA);

          // Smooth scroll to chart
          qs("#deviceChart")?.scrollIntoView({ behavior: "smooth" });
        } catch (err) {
          console.error(err);
          showGlobal("warn", err.message || "Failed to load graph");
        } finally {
          setLoading(btn, false, "üìà Load Graph");
        }
      });

      function renderGraph(field, rows) {
        const ctx = qs("#deviceChart").getContext("2d");

        const labels = rows.map((r) => r.date_time);
        const values = rows.map((r) => Number(r[field]));

        if (deviceChartInstance) {
          deviceChartInstance.destroy();
        }

        deviceChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: field,
                data: values,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                ticks: { maxRotation: 45, minRotation: 45 },
              },
            },
          },
        });
      }

      /*************************
       * CSV Export
       *************************/
      qs("#exportCsvBtn")?.addEventListener("click", async () => {
        const btn = qs("#exportCsvBtn");

        if (!ALL_DEVICE_DATA.length) {
          showGlobal("warn", "No data to export. Load graph first.");
          return;
        }

        // üî¥ VISUAL LOCK
        btn.disabled = true;
        btn.classList.add("opacity-70", "cursor-not-allowed");
        setLoading(btn, true, "üì• Exporting...");

        try {
          showGlobal("ok", "Preparing CSV from all pages...");

          // Let browser paint spinner
          await new Promise((r) => requestAnimationFrame(r));

          const csv = convertToCSV(ALL_DEVICE_DATA);
          downloadCSV(csv, "agridoot_devdata.csv");

          // Small delay so user sees feedback
          await new Promise((r) => setTimeout(r, 300));
        } catch (err) {
          console.error(err);
          showGlobal("warn", "CSV export failed");
        } finally {
          // üîµ UNLOCK UI
          btn.disabled = false;
          btn.classList.remove("opacity-70", "cursor-not-allowed");
          setLoading(btn, false, "üì• Export Data");
        }
      });

      function convertToCSV(rows) {
        const headers = Object.keys(rows[0]);
        const csvRows = [
          headers.join(","),
          ...rows.map((r) => headers.map((h) => `"${r[h] ?? ""}"`).join(",")),
        ];
        return csvRows.join("\n");
      }

      function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      /*************************
       * API Calls
       *************************/
      async function apiGetList(serial) {
        const url = new URL(API_BASE + "/list");
        if (serial && serial.trim())
          url.searchParams.set("serial_no", serial.trim());
        const res = await fetch(url, { method: "GET" });
        if (!res.ok) throw new Error("List fetch failed: " + res.status);
        return res.json();
      }

      async function apiRegisterDevice(data) {
        const formData = new FormData();
        Object.entries(data).forEach(([k, v]) => formData.append(k, v));
        const res = await fetch(API_BASE + "/reg", {
          method: "POST",
          body: formData,
        });
        const text = await res.text();
        let payload;
        try {
          payload = JSON.parse(text);
        } catch {
          payload = text;
        }
        // Special handling for 207 ‚Äî show message on top
        if (res.status === 207) {
          return { status: 207, payload };
        }
        if (!res.ok)
          throw new Error(
            (payload && payload.message) || "Registration failed"
          );
        return { status: res.status, payload };
      }

      /*************************
       * API ‚Äî Device by Phone & Data
       *************************/
      async function apiGetDeviceByPhone(phone, cc = "91") {
        const url = `https://api.novosedge.xyz:4433/ad/user/login?cc=${cc}&phone=${phone}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("User lookup failed");
        return res.json();
      }

      async function apiGetDeviceData({
        dev_id,
        from_date,
        to_date,
        page = 1,
        per_page = 100,
        type = "cache",
      }) {
        const url = new URL("https://api.novosedge.xyz:4433/ad/dev/data");
        url.searchParams.set("dev_id", dev_id);
        url.searchParams.set("type", type);
        url.searchParams.set("from_date", from_date);
        url.searchParams.set("to_date", to_date);
        url.searchParams.set("page", page);
        url.searchParams.set("per_page", per_page);

        const res = await fetch(url);
        if (!res.ok) throw new Error("Device data fetch failed");
        return res.json();
      }

      /*************************
       * UI ‚Äî Register form
       *************************/
      qs("#regForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearGlobal();
        if (!isSessionActive()) {
          alert("Please sign in first.");
          return;
        }
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        if (!["pod", "pro"].includes(data.dev_type))
          return alert("Invalid device type");
        if (!["Airtel", "Jio", "VI"].includes(data.sim_type))
          return alert("Invalid SIM type");
        const btn = qs("#submitBtn");
        const toast = qs("#regToast");
        setLoading(btn, true);
        toast.classList.add("hidden");
        try {
          const resp = await apiRegisterDevice(data);
          if (resp.status === 207) {
            const msg =
              typeof resp.payload === "string"
                ? resp.payload
                : resp.payload.message || JSON.stringify(resp.payload);
            showGlobal("warn", msg || "Partial success (207)");
          } else {
            showToast(toast, "ok", "Device registered successfully.");
            e.target.reset();
          }
          await loadDeviceList();
        } catch (err) {
          showToast(toast, "err", err.message || "Failed to register");
        } finally {
          setLoading(btn, false);
        }
      });

      /*************************
       * UI ‚Äî List & search (dynamic columns)
       *************************/
      qs("#refreshBtn").addEventListener("click", () =>
        loadDeviceList(qs("#searchSerial").value)
      );
      qs("#searchBtn").addEventListener("click", () =>
        loadDeviceList(qs("#searchSerial").value)
      );
      qs("#searchSerial").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          loadDeviceList(qs("#searchSerial").value);
        }
      });

      function buildTable(rows) {
        const thead = qs("#deviceThead");
        const tbody = qs("#deviceTbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";
        if (!rows.length) return;
        // Collect all keys
        const cols = Array.from(
          rows.reduce((set, r) => {
            Object.keys(r || {}).forEach((k) => set.add(k));
            return set;
          }, new Set())
        );
        // Header
        cols.forEach((k) => {
          const th = document.createElement("th");
          th.className = "px-4 py-3";
          th.textContent = k;
          thead.appendChild(th);
        });
        // Body
        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");
          tr.className = idx % 2 ? "bg-gray-50/40" : "";
          cols.forEach((k) => {
            const td = document.createElement("td");
            td.className = "px-4 py-3";
            let v = r[k];
            if (
              k.toLowerCase().includes("date") ||
              k.toLowerCase().includes("time")
            )
              v = humanDate(v);
            td.textContent = (v ?? "").toString();
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      /*************************
       * UI ‚Äî Device data table
       *************************/
      function renderDeviceDataTable(rows) {
        const thead = qs("#dataThead");
        const tbody = qs("#dataTbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        if (!rows.length) {
          tbody.innerHTML =
            "<tr><td class='px-4 py-6 text-center text-gray-500'>No data available</td></tr>";
          return;
        }

        const cols = Object.keys(rows[0]);

        cols.forEach((c) => {
          const th = document.createElement("th");
          th.className = "px-3 py-2 text-xs";
          th.textContent = c;
          thead.appendChild(th);
        });

        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");
          tr.className = idx % 2 ? "bg-gray-50/40" : "";

          cols.forEach((c) => {
            const td = document.createElement("td");
            td.className = "px-3 py-2 text-xs";
            let v = r[c];
            if (c.toLowerCase().includes("date")) v = humanDate(v);
            td.textContent = v ?? "";
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      }

      async function loadDeviceList(serial = "") {
        if (!isSessionActive()) return;
        const tbody = qs("#deviceTbody");
        const thead = qs("#deviceThead");
        const empty = qs("#listEmpty");
        thead.innerHTML = "";
        tbody.innerHTML = `<tr><td class='px-4 py-6 text-center text-sm text-gray-500' colspan='99'>Loading devices...</td></tr>`;
        empty.classList.add("hidden");
        try {
          const result = await apiGetList(serial);
          // Flexible extraction of rows from various API shapes
          const extractRows = (payload) => {
            if (Array.isArray(payload)) return payload;
            const keys = ["data", "rows", "result", "items", "devices", "list"];
            for (const k of keys) {
              if (Array.isArray(payload?.[k])) return payload[k];
            }
            // search first array value
            if (payload && typeof payload === "object") {
              const firstArr = Object.values(payload).find((v) =>
                Array.isArray(v)
              );
              if (Array.isArray(firstArr)) return firstArr;
            }
            return [];
          };
          const rows = extractRows(result);
          thead.innerHTML = "";
          tbody.innerHTML = "";
          if (!rows.length) {
            empty.classList.remove("hidden");
            return;
          }
          buildTable(rows);
        } catch (e) {
          console.error("List error:", e);
          tbody.innerHTML = `<tr><td colspan='99' class='px-4 py-6 text-center text-red-600'>Failed to load list: ${e.message}</td></tr>`;
        }
      }

      qs("#fetchByPhoneBtn")?.addEventListener("click", handleFetchByPhone);

      if (isSessionActive()) loadDeviceList();
    </script>
  </body>
</html>

