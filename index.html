<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>AgriDoot ‚Äî Analytics Hub</title>
    <link rel="icon" type="image/x-icon" href="/agfav.ico" />

    <!-- TailwindCSS (play CDN for quick prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      :root {
        --bg: #f6f9fb;
        --card: #ffffff;
        --muted: #6b7280; /* gray-500 */
        --accent-grad: linear-gradient(90deg, #16a34a, #06b6d4, #7c3aed);
        --glass-border: rgba(15, 23, 42, 0.04);
      }

      html,
      body {
        height: 100%;
      }
      body {
        background: var(--bg);
        color: #0f172a; /* slate-900 */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Soft background shapes for techy feel */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background-image: radial-gradient(
            600px 300px at 5% 10%,
            rgba(34, 197, 94, 0.06),
            transparent 10%
          ),
          radial-gradient(
            500px 250px at 95% 90%,
            rgba(14, 165, 166, 0.05),
            transparent 10%
          ),
          linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
        background-size: cover;
      }

      /* Modern elevated card */
      .glass {
        background: var(--card);
        border: 1px solid var(--glass-border);
        box-shadow: 0 6px 22px rgba(15, 23, 42, 0.06),
          inset 0 1px 0 rgba(255, 255, 255, 0.6);
        color: inherit;
      }

      .accent-bar {
        height: 6px;
        border-radius: 12px;
        background: var(--accent-grad);
        background-size: 300% 100%;
        animation: accentShift 6s linear infinite;
      }
      @keyframes accentShift {
        0% {
          background-position: 0%;
        }
        50% {
          background-position: 100%;
        }
        100% {
          background-position: 0%;
        }
      }

      .muted {
        color: var(--muted);
      }
      .chip {
        background: #f1f5f9;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(2, 6, 23, 0.03);
      }

      header .logo-wrap {
        border-left: 1px solid rgba(2, 6, 23, 0.03);
        padding-left: 12px;
      }

      .data-table th {
        font-weight: 600;
        font-size: 12px;
        color: #0b5b33;
      }
      .data-table td {
        font-size: 13px;
      }

      /* small responsive tweaks */
      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
      }

      /* subtle skeleton for loading */
      .skeleton {
        background: linear-gradient(90deg, #f3f4f6, #e9eef3, #f3f4f6);
        background-size: 200% 100%;
        animation: ske 1.4s linear infinite;
      }
      @keyframes ske {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* simple accessible focus style */
      :focus {
        outline: 3px solid rgba(99, 102, 241, 0.12);
        outline-offset: 2px;
      }

      /* USER PANE (left sidebar) */
      .user-pane {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        margin-bottom: 12px;
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid rgba(2, 6, 23, 0.04);
      }
      .user-avatar {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        object-fit: cover;
      }
      .user-meta {
        display: flex;
        flex-direction: column;
        min-width: 120px;
      }
      .user-name {
        font-weight: 700;
        font-size: 15px;
        color: #0f172a;
      }
      .user-email {
        color: var(--muted);
        font-size: 12px;
        word-break: break-all;
      }
      .session-expiry {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
    </style>
  </head>

  <body class="min-h-screen font-sans">
    <!-- Centered Google Sign-in only view (shown until authenticated) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
      <div class="glass rounded-2xl p-8 max-w-md w-full text-center">
        <div class="flex items-center justify-center mb-4">
          <img src="agrm.png" alt="AgriDoot Logo" class="w-14 h-14 mr-3" />
          <div class="text-left">
            <h2 class="text-2xl font-bold text-slate-800">
              AgriDoot ‚Äî Sign in
            </h2>
            <div class="muted text-sm">Secure dashboard access</div>
          </div>
        </div>
        <p class="mt-4 text-sm muted">
          Sign in with your Google account to access analytics and telemetry.
        </p>

        <div
          id="g_id_onload"
          data-client_id="720727892020-rtfm0ej4t214f04kejpuqbovii6nb95f.apps.googleusercontent.com"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"
        ></div>
        <div
          class="g_id_signin mx-auto mt-6"
          data-type="standard"
          data-theme="outline"
          data-size="large"
          data-shape="pill"
          style="width: 260px"
        ></div>

        <p class="mt-6 text-xs muted">
          Only authorized users can access this dashboard.
        </p>
      </div>
    </div>

    <!-- Protected content: hidden until login succeeds -->
    <div id="app" class="hidden">
      <div class="max-w-7xl mx-auto px-4 py-8">
        <div
          class="glass rounded-2xl p-4 flex items-center justify-between gap-6"
        >
          <div class="flex items-center gap-4">
            <div
              class="p-2 rounded-xl bg-gradient-to-tr from-green-500 to-cyan-400 shadow-md"
            >
              <img src="agrm.png" alt="AgriDoot" class="w-10 h-10 block" />
            </div>
            <div class="logo-wrap pl-4">
              <h1 class="text-2xl font-extrabold tracking-tight text-slate-900">
                AgriDoot <span class="text-sm muted">Command Hub</span>
              </h1>
              <div class="muted text-xs">
                Modern Analytics ¬∑ Real-Time Telemetry
              </div>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div class="chip hidden sm:inline">
              Mode: <b id="mode-top" class="ml-2">‚Äî</b>
            </div>
            <button
              id="logout-btn"
              class="ml-2 px-3 py-2 rounded-lg text-sm bg-white border border-gray-200 shadow-sm"
            >
              Logout
            </button>
          </div>
        </div>

        <!-- Accent bar -->
        <div class="mt-3 accent-bar rounded-xl"></div>

        <!-- Main grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
          <!-- Left column: quick stats + user pane -->
          <aside class="lg:col-span-1 glass p-5 rounded-2xl">
            <!-- USER PANE (injected) -->
            <div id="user-pane"></div>

            <h2 class="font-semibold text-lg text-slate-900">Quick Overview</h2>
            <p class="muted text-sm mb-4">Snapshot of current system health</p>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm muted">Status</div>
                  <div id="status-pill" class="font-bold text-lg">‚Äî</div>
                </div>
                <div class="text-right">
                  <div class="text-sm muted">Uptime</div>
                  <div id="uptime-pill" class="font-medium">‚Äî</div>
                </div>
              </div>

              <div class="border-t border-gray-100 pt-3">
                <div class="text-sm muted">Users</div>
                <div class="text-2xl font-bold" id="users-count">‚Äî</div>
                <div class="muted text-xs" id="users-active">Active: ‚Äî</div>
              </div>

              <div class="grid grid-cols-2 gap-2 mt-3">
                <div class="glass p-3 rounded-lg text-center">
                  <div class="muted text-xs">Vyom Areas</div>
                  <div id="vyom-area" class="font-semibold">‚Äî</div>
                </div>
                <div class="glass p-3 rounded-lg text-center">
                  <div class="muted text-xs">Devices</div>
                  <div id="devices" class="font-semibold">‚Äî</div>
                </div>
              </div>

              <div class="mt-4 space-y-2">
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://agridoot.com/"
                  >üåê AgriDoot</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://tiler.agridoot.in/"
                  >üõ∞Ô∏è Vyom Tiler</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://plans.agridoot.in/"
                  >üíµ Vyom - Price Calculator</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://media.agridoot.in/"
                  >üóÑÔ∏è Media Manager</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://notify.agridoot.co.in:9443/"
                  >üêô Notify System</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://vyom.agridoot.co.in/html/sign-up.html"
                  >üåø Vyom Dashboard</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://sales.agridoot.in/"
                  >üìà Sales & TeleCalling</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://iot.agridoot.in/"
                  >üé¥ IoT Registration</a
                >
              </div>
            </div>
          </aside>

          <!-- Right column: large panels -->
          <main class="lg:col-span-3 space-y-6">
            <!-- Summary cards row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="glass p-5 rounded-2xl">
                <div class="muted text-xs">Users</div>
                <div class="text-2xl font-bold" id="users-count-large">‚Äî</div>
                <div class="muted text-sm" id="users-active-large">
                  Active ‚Äî
                </div>
              </div>
              <div class="glass p-5 rounded-2xl">
                <div class="muted text-xs">Vyom</div>
                <div class="text-2xl font-bold" id="vyom-count">‚Äî</div>
                <div class="muted text-sm">
                  Area - <span id="vyom-area-large">‚Äî</span> acres
                </div>
              </div>
              <div class="glass p-5 rounded-2xl">
                <div class="muted text-xs">Gyan Queries</div>
                <div class="text-2xl font-bold" id="gyan-queries">‚Äî</div>
                <div class="muted text-sm">Realtime assistance</div>
              </div>
            </div>

            <!-- Charts area -->
            <div class="glass p-4 rounded-2xl">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-900">User Growth</h3>
                <div class="flex items-center gap-2">
                  <select
                    id="period"
                    class="bg-white border border-gray-200 rounded px-3 py-1 text-sm"
                    onchange="fetchUserCounts()"
                  >
                    <option value="last_7_days">Last 7 days</option>
                    <option value="this_month" selected>This month</option>
                    <option value="last_month">Last month</option>
                    <option value="last_6_months">Last 6 months</option>
                    <option value="last_1_year">1 year</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>

              <div class="space-y-4">
                <div class="p-2 glass rounded-lg">
                  <canvas id="userDateChart" height="360"></canvas>
                </div>
                <div class="p-2 glass rounded-lg">
                  <canvas id="userMonthlyChart" height="360"></canvas>
                </div>
                <div class="p-2 glass rounded-lg">
                  <canvas id="userRegionChart" height="360"></canvas>
                </div>
              </div>
            </div>

            <!-- Analytics Table -->
            <div class="glass p-4 rounded-2xl">
              <div
                class="flex flex-col md:flex-row md:items:center md:justify-between gap-3 mb-3"
              >
                <h3 class="font-semibold text-slate-900">Analytics</h3>
                <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
                  <select
                    id="user-type"
                    class="flex-1 md:flex-none bg-white border border-gray-200 rounded px-3 py-1 text-sm min-w-[120px]"
                  >
                    <option value="all">All</option>
                    <option value="paid">Paid</option>
                    <option value="non-paid">Non-Paid</option>
                    <option value="non-farm">Non-Farm</option>
                  </select>
                  <input
                    id="search"
                    placeholder="Search..."
                    class="flex-1 md:flex-none bg-white border border-gray-200 rounded px-3 py-1 text-sm min-w-[160px]"
                  />
                  <button
                    onclick="fetchAnalytics(1)"
                    class="btn-primary text-sm rounded px-4 py-1 w-full md:w-auto"
                    style="
                      background: var(--accent-grad);
                      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.08);
                    "
                  >
                    Show
                  </button>
                </div>
              </div>

              <div class="overflow-auto">
                <table class="w-full text-left data-table">
                  <thead id="table-headers" class="text-xs"></thead>
                  <tbody id="user-table" class="text-sm"></tbody>
                </table>
              </div>

              <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4"
              >
                <div class="muted text-sm">
                  Page <span id="page-num">1</span>
                </div>
                <div class="flex gap-2">
                  <button
                    onclick="prevPage()"
                    class="px-3 py-1 rounded bg-white border border-gray-200"
                  >
                    Prev
                  </button>
                  <button
                    onclick="nextPage()"
                    class="px-3 py-1 rounded"
                    style="background: var(--accent-grad); color: white"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>

            <footer class="text-sm muted text-center">
              AgriDoot ‚Äî By NovosEdge ¬© 2024
            </footer>
          </main>
        </div>
      </div>
    </div>

    <!-- Modal: Session expired -->
    <div
      id="session-modal"
      class="fixed inset-0 hidden items-center justify-center z-50"
    >
      <div class="bg-black/10 absolute inset-0"></div>
      <div class="glass p-6 rounded-2xl z-60 max-w-md mx-auto">
        <h3 class="text-lg font-semibold text-slate-900">Session expired</h3>
        <p class="muted mt-2">
          Please sign in again to continue using the dashboard.
        </p>
        <div class="mt-4 flex justify-end">
          <button
            onclick="closeModal()"
            class="px-4 py-2 rounded bg-white border border-gray-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script>
      // Helpers
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      let whitelist = [];
      let logoutTimer = null;
      let countdownInterval = null;
      let currentPage = 1;

      // Initial load: read config.json for whitelist
      fetch("config.json")
        .then((r) => r.json())
        .then((c) => {
          whitelist = c.whitelist || [];
          checkExistingLogin();
        })
        .catch(() => {
          console.warn("config.json not found or invalid");
        });

      // Google callback (must be global)
      function handleCredentialResponse(response) {
        try {
          const data = parseJwt(response.credential);
          const email = data.email;
          const name = data.name || "";
          const picture = data.picture || "";
          if (whitelist.includes(email)) {
            const loginData = { email, name, picture, timestamp: Date.now() };
            localStorage.setItem("agridoot_user", JSON.stringify(loginData));
            showDashboard();
          } else {
            alert(
              "‚ùå Access Denied: " +
                email +
                " is not authorized. Contact Admin."
            );
          }
        } catch (err) {
          console.error("login parse error", err);
          alert("Login failed");
        }
      }

      // Robust JWT parsing for ID token
      function parseJwt(token) {
        try {
          const payload = token.split(".")[1];
          const padded = payload.padEnd(
            payload.length + ((4 - (payload.length % 4)) % 4),
            "="
          );
          const json = atob(padded.replace(/-/g, "+").replace(/_/g, "/"));
          return JSON.parse(decodeURIComponent(escape(json)));
        } catch (e) {
          // fallback simpler parse
          const b = token.split(".")[1];
          return JSON.parse(atob(b.replace(/-/g, "+").replace(/_/g, "/")));
        }
      }

      // check localStorage session
      function checkExistingLogin() {
        const saved = localStorage.getItem("agridoot_user");
        if (!saved) return;
        try {
          const d = JSON.parse(saved);
          const now = Date.now();
          const sessionLimit = 24 * 60 * 60 * 1000; // 24 hours
          if (whitelist.includes(d.email) && now - d.timestamp < sessionLimit) {
            const remaining = sessionLimit - (now - d.timestamp);
            showDashboard(remaining);
          } else {
            logout();
          }
        } catch (e) {
          logout();
        }
      }

      function showDashboard(remainingTime = 24 * 60 * 60 * 1000) {
        // reveal UI
        $("#auth-screen").classList.add("hidden");
        $("#app").classList.remove("hidden");

        // render user pane in left sidebar
        renderUserPane();

        // fetch backend summary & charts
        fetchPing();
        fetchSummary();
        fetchUserCounts();

        // set logout timer
        if (logoutTimer) clearTimeout(logoutTimer);
        logoutTimer = setTimeout(() => {
          openModal();
          logout();
        }, remainingTime);

        startSessionCountdown(remainingTime);
      }

      function logout() {
        try {
          localStorage.removeItem("agridoot_user");
        } catch (e) {}
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        if (logoutTimer) {
          clearTimeout(logoutTimer);
          logoutTimer = null;
        }
        $("#app").classList.add("hidden");
        $("#auth-screen").classList.remove("hidden");
        const up = $("#user-pane");
        if (up) up.innerHTML = "";
      }

      function openModal() {
        document.getElementById("session-modal").classList.remove("hidden");
        document.getElementById("session-modal").classList.add("flex");
      }
      function closeModal() {
        document.getElementById("session-modal").classList.add("hidden");
        document.getElementById("session-modal").classList.remove("flex");
      }

      // Fetching endpoints with safe fallbacks
      function fetchPing() {
        fetch("https://apiv2.agridoot.co.in:12443/ping")
          .then((r) => r.json())
          .then((data) => {
            $("#status-pill").textContent = data.status || "‚Äî";
            $("#status-pill").className =
              data.status === "ok"
                ? "text-green-600 font-bold"
                : "text-rose-600 font-bold";
            $("#uptime-pill").textContent = data.uptime || "‚Äî";
            $("#mode-top").textContent = data.mode || "‚Äî";
          })
          .catch((err) => {
            console.warn("ping failed", err);
            $("#status-pill").textContent = "unreachable";
            $("#status-pill").className = "text-rose-600 font-bold";
          });
      }

      function fetchSummary() {
        fetch("https://api.novosedge.xyz:4433/ad/live")
          .then((r) => r.json())
          .then((data) => {
            const s = data.summary || {};
            $("#users-count").textContent = s.userCnt ?? "‚Äî";
            $("#users-count-large").textContent = s.userCnt ?? "‚Äî";
            $("#users-active").textContent = "Active: " + (s.userActive ?? "‚Äî");
            $("#users-active-large").textContent =
              "Active " + (s.userActive ?? "‚Äî");
            $("#vyom-count").textContent = s.vyomCnt ?? "‚Äî";
            $("#vyom-area").textContent = s.vyomArea ?? "‚Äî";
            $("#vyom-area-large").textContent = s.vyomArea ?? "‚Äî";
            $("#gyan-queries").textContent = s.gyanQue ?? "‚Äî";
            $("#devices").textContent = s.devCnt ?? "‚Äî";
          })
          .catch((e) => console.warn("summary fetch failed", e));
      }

      // Charts
      let dateChart = null;
      let regionChart = null;
      let monthlyChart = null;

      function fetchUserCounts() {
        const period = document.getElementById("period").value;
        fetch(`https://api.novosedge.xyz:4433/ad/counts?period=${period}`)
          .then((r) => (r.ok ? r.json() : Promise.reject(r.statusText)))
          .then((data) => {
            if (!data.infoUser) return;

            // --- Date-wise chart (Users + Installs) ---
            const dateItems = data.infoUser.infoCnt || [];

            // Convert API date strings to readable format (oldest ‚Üí newest)
            const dates = dateItems
              .map((d) => new Date(d.day).toLocaleDateString())
              .reverse();
            const userCounts = dateItems
              .map((d) => Number(d.user_count))
              .reverse();
            const installCounts = dateItems
              .map((d) => Number(d.user_installs))
              .reverse();

            if (dateChart) {
              dateChart.destroy();
              dateChart = null;
            }

            const dateCtx = document.querySelector("#userDateChart");
            if (dateCtx) {
              dateChart = new Chart(dateCtx, {
                type: "line",
                data: {
                  labels: dates,
                  datasets: [
                    {
                      label: "Users (Signups)",
                      data: userCounts,
                      borderColor: "#16a34a", // green
                      backgroundColor: "rgba(22,163,74,0.08)",
                      tension: 0.3,
                      fill: false,
                      pointRadius: 3,
                    },
                    {
                      label: "Users (Installs - Estimated)",
                      data: installCounts,
                      borderColor: "#F44336", // red
                      backgroundColor: "rgba(244, 67, 54, 0.2)",
                      tension: 0.3,
                      fill: false,
                      pointRadius: 3,
                    },
                  ],
                },
                options: {
                  plugins: { legend: { display: true, position: "top" } },
                  scales: {
                    x: { display: true },
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                  },
                  responsive: true,
                  maintainAspectRatio: false,
                },
              });
            }

            // --- Region-wise chart (horizontal bar) ---
            const regionItems = data.infoUser.infoRegion || [];
            const regions = regionItems.map((r) => r.region);
            const regionCounts = regionItems.map((r) => Number(r.user_count));

            if (regionChart) {
              regionChart.destroy();
              regionChart = null;
            }

            const regionCtx = document.querySelector("#userRegionChart");
            if (regionCtx) {
              regionChart = new Chart(regionCtx, {
                type: "bar",
                data: {
                  labels: regions,
                  datasets: [
                    {
                      label: "Users",
                      data: regionCounts,
                      barThickness: 18,
                      backgroundColor: "rgba(99,102,241,0.8)",
                    },
                  ],
                },
                options: {
                  indexAxis: "y",
                  plugins: { legend: { display: false } },
                  scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                },
              });
            }

            // --- Monthly total chart (vertical bar) ---
            const monthlyItems = data.infoUser.infoMonthlyThisYear || [];
            const monthLabels = monthlyItems.map((m) => m.month);
            const monthCounts = monthlyItems.map((m) => Number(m.total_count));

            if (monthlyChart) {
              monthlyChart.destroy();
              monthlyChart = null;
            }

            const monthlyCtx = document.querySelector("#userMonthlyChart");
            if (monthlyCtx) {
              monthlyChart = new Chart(monthlyCtx, {
                type: "bar",
                data: {
                  labels: monthLabels,
                  datasets: [
                    {
                      label: "Total Users (This Year)",
                      data: monthCounts,
                      backgroundColor: "rgba(124,58,237,0.8)",
                    },
                  ],
                },
                options: {
                  plugins: { legend: { display: false } },
                  scales: {
                    x: { beginAtZero: true },
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                  },
                  responsive: true,
                  maintainAspectRatio: false,
                },
              });
            }
          })
          .catch((e) => {
            console.warn("counts fetch failed", e);
          });
      }

      // Analytics table
      function fetchAnalytics(page = 1) {
        currentPage = page;
        document.getElementById("page-num").textContent = page;
        const type = $("#user-type").value;
        const search = encodeURIComponent($("#search").value || "");
        fetch(
          `https://api.novosedge.xyz:4433/ad/analytics?type=${type}&page=${page}&search=${search}`
        )
          .then((r) => (r.ok ? r.json() : Promise.reject(r.statusText)))
          .then((data) => {
            const table = $("#user-table");
            table.innerHTML = "";
            if (!data.userStats || !data.userStats.length) {
              $("#table-headers").innerHTML = "";
              return;
            }
            const headers = Object.keys(data.userStats[0]);
            $("#table-headers").innerHTML = `<tr>${headers
              .map((h) => `<th class='px-4 py-3'>${h}</th>`)
              .join("")}</tr>`;
            data.userStats.forEach((row) => {
              const tr = document.createElement("tr");
              headers.forEach((h) => {
                const td = document.createElement("td");
                td.className = "px-4 py-3 border-t border-gray-100";
                td.textContent = row[h] ?? "-";
                tr.appendChild(td);
              });
              table.appendChild(tr);
            });
          })
          .catch((e) => console.warn("analytics fetch failed", e));
      }

      function nextPage() {
        fetchAnalytics(currentPage + 1);
      }
      function prevPage() {
        if (currentPage > 1) fetchAnalytics(currentPage - 1);
      }

      // initialize: do NOT fetch protected data until authenticated
      document.addEventListener("DOMContentLoaded", () => {});

      // Logout button
      document.getElementById("logout-btn").addEventListener("click", () => {
        logout();
        alert("Logged out");
      });

      /* ---- New: Render user pane in left sidebar + session countdown ---- */

      function renderUserPane() {
        const saved = localStorage.getItem("agridoot_user");
        const container = $("#user-pane");
        container.innerHTML = ""; // clear
        if (!saved) return;
        let d;
        try {
          d = JSON.parse(saved);
        } catch (e) {
          return;
        }
        const name = escapeHtml(d.name || d.email || "User");
        const email = escapeHtml(d.email || "");
        const pic = d.picture || "agrm.png";

        const html = `
          <div class="user-pane">
            <img src="${pic}" alt="avatar" class="user-avatar" onerror="this.src='agrm.png'"/>
            <div class="user-meta">
              <div class="user-name">${name}</div>
              <div class="user-email">${email}</div>
              <div class="session-expiry" id="sidebar-expiry">Expiry: ‚Äî</div>
            </div>
          </div>
        `;
        container.innerHTML = html;
      }

      function startSessionCountdown(remainingMs) {
        // clear existing
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        const label = document.getElementById("sidebar-expiry");
        if (!label) return;

        let ms = Number(remainingMs) || 0;

        function tick() {
          if (ms <= 0) {
            label.textContent = "Expiry: 00:00:00";
            openModal();
            logout();
            return;
          }
          const h = Math.floor(ms / (1000 * 60 * 60));
          const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((ms % (1000 * 60)) / 1000);
          label.textContent = `Expiry: ${pad(h)}:${pad(m)}:${pad(s)}`;
          ms -= 1000;
        }

        tick();
        countdownInterval = setInterval(tick, 1000);
      }

      function pad(n) {
        return (n < 10 ? "0" : "") + n;
      }

      // small escape helper
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, function (s) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[s];
        });
      }
    </script>
  </body>
</html>
