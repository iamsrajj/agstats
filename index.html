<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <meta
      name="googlebot"
      content="noindex, nofollow, nosnippet, noarchive, notranslate"
    />

    <title>AgriDoot - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/agfav.ico" />

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white min-h-screen"
  >
    <!-- Login Section -->
    <div
      id="login-section"
      class="flex justify-center items-center min-h-screen"
    >
      <div class="glass shadow-xl rounded-2xl p-8 max-w-md w-full text-center">
        <div class="flex items-center justify-center mb-4">
          <img src="agrm.png" alt="AgriDoot Logo" class="w-16 h-16 mr-2" />
          <h2 class="text-3xl font-bold text-green-400">Dashboard</h2>
        </div>
        <p class="text-gray-300 mb-6">Sign in securely to continue</p>

        <!-- Google Sign-In -->
        <div
          id="g_id_onload"
          data-client_id="720727892020-rtfm0ej4t214f04kejpuqbovii6nb95f.apps.googleusercontent.com"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"
        ></div>
        <div
          class="g_id_signin"
          data-type="standard"
          data-shape="pill"
          data-theme="filled_blue"
          data-text="continue_with"
          data-size="large"
          data-logo_alignment="left"
        ></div>

        <p class="mt-6 text-sm text-gray-400">
          Only authorized users can access this dashboard.
        </p>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden p-6">
      <h1 class="text-4xl font-extrabold text-green-400 mb-8">
        AgriDoot - Analytics Panel
      </h1>

      <!-- Status Overview -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3">Status Overview</h2>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="glass p-3 rounded-lg">
            Status: <span id="status"></span>
          </div>
          <div class="glass p-3 rounded-lg">
            Uptime: <span id="uptime"></span>
          </div>
          <div class="glass p-3 rounded-lg">Version: <b id="version"></b></div>
          <div class="glass p-3 rounded-lg">Build: <b id="build"></b></div>
          <div class="glass p-3 rounded-lg">Mode: <b id="mode"></b></div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="glass p-6 rounded-xl">
          <h3 class="text-center font-bold text-lg mb-2">Users</h3>
          <p>Users: <b id="users-count"></b></p>
          <p>Active: <b id="users-active"></b></p>
        </div>
        <div class="glass p-6 rounded-xl">
          <h3 class="text-center font-bold text-lg mb-2">Vyom</h3>
          <p>Vyom: <b id="vyom-count"></b></p>
          <p>Area (acres): <b id="vyom-area"></b></p>
        </div>
        <div class="glass p-6 rounded-xl">
          <h3 class="text-center font-bold text-lg mb-2">Other</h3>
          <p>Gyan Queries: <b id="gyan-queries"></b></p>
          <p>Devices: <b id="devices"></b></p>
        </div>
      </div>

      <!-- User Growth -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3">User Growth</h2>
        <select
          id="period"
          onchange="fetchUserCounts()"
          class="bg-gray-800 text-white rounded p-2"
        >
          <option value="last_7_days">Last 7 Days</option>
          <option value="this_month" selected>This Month</option>
          <option value="last_month">Last Month</option>
          <option value="last_6_months">Last 6 Months</option>
          <option value="last_1_year">Last 1 Year</option>
          <option value="this_year">This Year</option>
          <option value="all">All</option>
        </select>

        <div class="glass p-6 mt-4 rounded-xl">
          <h3 class="text-center font-semibold">Users Date-wise</h3>
          <canvas id="userDateChart"></canvas>
        </div>

        <div class="glass p-6 mt-6 rounded-xl">
          <h3 class="text-center font-semibold">Users Region-wise</h3>
          <canvas id="userRegionChart"></canvas>
        </div>
      </div>

      <!-- Analytics Section -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3">Analytics</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <select id="user-type" class="bg-gray-800 text-white rounded p-2">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="non-paid">Non-Paid</option>
            <option value="non-farm">Non-Farm</option>
          </select>
          <select id="order" class="bg-gray-800 text-white rounded p-2">
            <option value="desc">Newest</option>
            <option value="asc">Older</option>
          </select>
          <input
            type="text"
            id="search"
            placeholder="Search from data"
            class="bg-gray-800 text-white rounded p-2"
          />
          <button
            class="bg-green-600 hover:bg-green-700 text-white rounded p-2"
            onclick="fetchAnalytics(1)"
          >
            Show
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left border border-gray-700">
            <thead class="bg-gray-800" id="table-headers"></thead>
            <tbody id="user-table" class="text-gray-300"></tbody>
          </table>
        </div>

        <div class="flex justify-between mt-6">
          <button class="bg-gray-700 px-4 py-2 rounded" onclick="prevPage()">
            Prev
          </button>
          <button class="bg-green-600 px-4 py-2 rounded" onclick="nextPage()">
            Next
          </button>
        </div>
      </div>

      <!-- Others Section -->
      <div>
        <h2 class="text-xl font-semibold mb-3">Others</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://agridoot.com/')"
          >
            üåê AgriDoot
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://tiler.agridoot.in/')"
          >
            üõ∞Ô∏è Vyom Tiler
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://vyom.agridoot.co.in/html/sign-up.html')"
          >
            üåø Vyom Dashboard
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://notify.agridoot.co.in:9443/')"
          >
            üêô Notify System
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://sales.agridoot.in/')"
          >
            üìà Sales & TeleCalling
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://plans.agridoot.in/')"
          >
            üíµ Vyom Price Calculator
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://media.agridoot.in/')"
          >
            üóÑÔ∏è Media Manager
          </div>
          <div
            class="glass p-4 text-center rounded-xl hover:bg-green-800 cursor-pointer"
            onclick="window.open('https://iot.agridoot.in/')"
          >
            üé¥ IoT Registration
          </div>
        </div>
      </div>

      <footer
        class="text-center text-gray-500 mt-10 border-t border-gray-700 pt-4"
      >
        AgriDoot - By NovosEdge &copy; 2024 All Rights Reserved.
      </footer>
    </div>

    <!-- Script: same functionality -->
    <script>
      let whitelist = [];
      let logoutTimer;

      fetch("config.json")
        .then((res) => res.json())
        .then((data) => {
          whitelist = data.whitelist;
          checkExistingLogin();
        });

      function handleCredentialResponse(response) {
        const data = parseJwt(response.credential);
        const email = data.email;
        if (whitelist.includes(email)) {
          const loginData = { email: email, timestamp: Date.now() };
          localStorage.setItem("agridoot_user", JSON.stringify(loginData));
          showDashboard();
        } else {
          alert(
            "‚ùå Access Denied: " + email + " is not authorized. Contact Admin."
          );
        }
      }

      function checkExistingLogin() {
        const saved = localStorage.getItem("agridoot_user");
        if (saved) {
          const loginData = JSON.parse(saved);
          const now = Date.now();
          const sessionLimit = 12 * 60 * 60 * 1000;
          if (
            whitelist.includes(loginData.email) &&
            now - loginData.timestamp < sessionLimit
          ) {
            showDashboard(sessionLimit - (now - loginData.timestamp));
          } else {
            logout();
          }
        }
      }

      function showDashboard(remainingTime = 30 * 60 * 1000) {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        fetchPing();
        fetchSummary();
        if (logoutTimer) clearTimeout(logoutTimer);
        logoutTimer = setTimeout(() => {
          alert("‚ö†Ô∏è Session expired. Please sign in again.");
          logout();
        }, remainingTime);
      }

      function logout() {
        localStorage.removeItem("agridoot_user");
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("login-section").classList.remove("hidden");
        if (logoutTimer) clearTimeout(logoutTimer);
      }

      function parseJwt(token) {
        let base64Url = token.split(".")[1];
        let base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        let jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
            .join("")
        );
        return JSON.parse(jsonPayload);
      }

      function fetchPing() {
        fetch("https://apiv2.agridoot.co.in:12443/ping")
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("status").textContent = data.status;
            document.getElementById("status").className =
              data.status === "ok"
                ? "text-green-400 font-bold"
                : "text-red-400 font-bold";
            document.getElementById("uptime").textContent = data.uptime;
            document.getElementById("version").textContent = data.version;
            document.getElementById("build").textContent = data.build;
            document.getElementById("mode").textContent = data.mode;
          });
      }

      function fetchSummary() {
        fetch("https://api.novosedge.xyz:4433/ad/live")
          .then((res) => res.json())
          .then((data) => {
            const s = data.summary;
            document.getElementById("users-count").textContent = s.userCnt;
            document.getElementById("users-active").textContent = s.userActive;
            document.getElementById("vyom-count").textContent = s.vyomCnt;
            document.getElementById("vyom-area").textContent = s.vyomArea;
            document.getElementById("gyan-queries").textContent = s.gyanQue;
            document.getElementById("devices").textContent = s.devCnt;
          });
      }

      let dateChart, regionChart;
      function fetchUserCounts() {
        const period = document.getElementById("period").value;
        fetch(`https://api.novosedge.xyz:4433/ad/counts?period=${period}`)
          .then((res) => res.json())
          .then((data) => {
            if (!data.infoUser) return;
            const dates = data.infoUser.infoCnt.map((d) =>
              new Date(d.day).toLocaleDateString()
            );
            const counts = data.infoUser.infoCnt.map((d) => d.user_count);
            if (dateChart) dateChart.destroy();
            dateChart = new Chart(document.getElementById("userDateChart"), {
              type: "line",
              data: {
                labels: dates.reverse(),
                datasets: [
                  {
                    label: "User Count",
                    data: counts.reverse(),
                    borderColor: "#22c55e",
                    backgroundColor: "rgba(34,197,94,0.2)",
                    fill: true,
                  },
                ],
              },
            });
            const regions = data.infoUser.infoRegion.map((r) => r.region);
            const regionCounts = data.infoUser.infoRegion.map(
              (r) => r.user_count
            );
            if (regionChart) regionChart.destroy();
            regionChart = new Chart(
              document.getElementById("userRegionChart"),
              {
                type: "bar",
                data: {
                  labels: regions,
                  datasets: [
                    {
                      label: "Users",
                      data: regionCounts,
                      backgroundColor: "rgba(59,130,246,0.7)",
                    },
                  ],
                },
                options: { indexAxis: "y" },
              }
            );
          });
      }

      let currentPage = 1;
      function fetchAnalytics(page = 1) {
        currentPage = page;
        const type = document.getElementById("user-type").value;
        const order = document.getElementById("order").value;
        const search = document.getElementById("search").value;
        fetch(
          `https://api.novosedge.xyz:4433/ad/analytics?type=${type}&order=${order}&page=${page}&search=${encodeURIComponent(
            search
          )}`
        )
          .then((res) => res.json())
          .then((data) => {
            const table = document.getElementById("user-table");
            table.innerHTML = "";
            if (!data.userStats.length) return;
            const headers = Object.keys(data.userStats[0]);
            document.getElementById("table-headers").innerHTML = `<tr>${headers
              .map((h) => `<th class='px-4 py-2'>${h}</th>`)
              .join("")}</tr>`;
            data.userStats.forEach((row) => {
              const tr = document.createElement("tr");
              headers.forEach((h) => {
                const td = document.createElement("td");
                td.textContent = row[h];
                td.className = "px-4 py-2 border border-gray-700";
                tr.appendChild(td);
              });
              table.appendChild(tr);
            });
          });
      }

      function nextPage() {
        fetchAnalytics(currentPage + 1);
      }
      function prevPage() {
        if (currentPage > 1) fetchAnalytics(currentPage - 1);
      }

      document.addEventListener("DOMContentLoaded", fetchUserCounts);
    </script>
  </body>
</html>

