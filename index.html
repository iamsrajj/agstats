<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>AgriDoot ‚Äî Analytics Hub</title>
    <link rel="icon" type="image/x-icon" href="/agfav.ico" />

    <!-- TailwindCSS (play CDN for quick prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      :root {
        --glass-bg: rgba(10, 12, 16, 0.45);
        --accent: linear-gradient(90deg, #22c55e, #06b6d4, #7c3aed);
      }
      html,
      body {
        height: 100%;
      }

      /* remove gradient from body itself */
      body {
        background: var(--bg-fallback, #020617); /* simple fallback color */
        position: relative;
        z-index: 0;
        color: #fff;
      }

      /* full-screen fixed background layer */
      body::before {
        content: "";
        position: fixed;
        inset: 0; /* top:0; right:0; bottom:0; left:0; */
        z-index: -1; /* behind everything */
        pointer-events: none;
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed; /* redundant but harmless */
        background-image: radial-gradient(
            1200px 600px at 10% 10%,
            rgba(124, 58, 237, 0.08),
            transparent 6%
          ),
          radial-gradient(
            1000px 500px at 90% 90%,
            rgba(6, 182, 212, 0.06),
            transparent 6%
          ),
          linear-gradient(180deg, #020617 0%, #071028 50%, #000000 100%);
        will-change: transform; /* hint for smoother rendering */
        transform: translateZ(0); /* create its own compositing layer */
      }

      /* Futuristic glass card */
      .glass {
        background: var(--glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(8px) saturate(1.1);
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.02);
      }

      /* subtle animated accent bar */
      .accent-bar {
        height: 4px;
        border-radius: 999px;
        background: var(--accent);
        background-size: 300% 100%;
        animation: accentShift 6s linear infinite;
      }
      @keyframes accentShift {
        0% {
          background-position: 0%;
        }
        50% {
          background-position: 100%;
        }
        100% {
          background-position: 0%;
        }
      }

      /* primary buttons */
      .btn-primary {
        background: linear-gradient(90deg, #16a34a, #0ea5a6);
        box-shadow: 0 6px 18px rgba(13, 148, 136, 0.12);
      }

      /* header glass stroke */
      header .logo-wrap {
        border-left: 1px solid rgba(255, 255, 255, 0.03);
      }

      /* table visuals */
      .data-table th {
        font-weight: 600;
        font-size: 12px;
        color: #bfe9d7;
      }
      .data-table td {
        font-size: 13px;
      }

      /* small utilities */
      .muted {
        color: rgba(230, 238, 248, 0.6);
      }
      .chip {
        background: rgba(255, 255, 255, 0.03);
        padding: 6px 10px;
        border-radius: 999px;
      }

      /* Loader */
      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.03)
        );
        background-size: 200% 100%;
        animation: ske 1.6s linear infinite;
      }
      @keyframes ske {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* small responsive tweaks */
      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
      }
    </style>
  </head>

  <body class="min-h-screen">
    <!-- Centered Google Sign-in only view (shown until authenticated) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
      <div class="glass rounded-2xl p-8 max-w-md w-full text-center">
        <div class="flex items-center justify-center mb-4">
          <img src="agrm.png" alt="AgriDoot Logo" class="w-16 h-16 mr-2" />
          <h2 class="text-3xl font-bold text-green-400">AgriDoot ‚Äî Sign in</h2>
        </div>
        <p class="text-gray-300 mb-6">
          Sign in securely with your Google account to access the dashboard
        </p>

        <div
          id="g_id_onload"
          data-client_id="720727892020-rtfm0ej4t214f04kejpuqbovii6nb95f.apps.googleusercontent.com"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"
        ></div>
        <div
          class="g_id_signin mx-auto"
          data-type="standard"
          data-theme="filled_blue"
          data-size="large"
          data-shape="pill"
          style="width: 260px"
        ></div>

        <p class="mt-6 text-sm text-gray-400">
          Only authorized users can access this dashboard.
        </p>
      </div>
    </div>

    <!-- Protected content: hidden until login succeeds -->
    <div id="app" class="hidden">
      <div class="max-w-7xl mx-auto px-4 py-8">
        <div
          class="glass rounded-2xl p-4 flex items-center justify-between gap-6"
        >
          <div class="flex items-center gap-4">
            <div
              class="p-2 rounded-xl bg-gradient-to-tr from-green-500 to-cyan-400 shadow-lg"
            >
              <img src="agrm.png" alt="AgriDoot" class="w-10 h-10 block" />
            </div>
            <div class="logo-wrap pl-4">
              <h1 class="text-2xl font-extrabold tracking-tight">
                AgriDoot <span class="text-sm muted">Command Hub</span>
              </h1>
              <div class="muted text-xs">
                Futuristic Analytics ¬∑ Real-Time Telemetry
              </div>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div class="chip hidden sm:inline">
              Mode: <b id="mode-top" class="ml-2">‚Äî</b>
            </div>
            <button
              id="logout-btn"
              class="ml-2 px-3 py-2 rounded-lg text-sm bg-transparent border border-white/8"
            >
              Logout
            </button>
          </div>
        </div>

        <!-- Accent bar -->
        <div class="mt-3 accent-bar rounded-xl"></div>

        <!-- Main grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
          <!-- Left column: quick stats + links -->
          <aside class="lg:col-span-1 glass p-5 rounded-2xl">
            <h2 class="font-semibold text-lg">Quick Overview</h2>
            <p class="muted text-sm mb-4">Snapshot of current system health</p>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm muted">Status</div>
                  <div id="status-pill" class="font-bold text-lg">‚Äî</div>
                </div>
                <div class="text-right">
                  <div class="text-sm muted">Uptime</div>
                  <div id="uptime-pill" class="font-medium">‚Äî</div>
                </div>
              </div>

              <div class="border-t border-white/6 pt-3">
                <div class="text-sm muted">Users</div>
                <div class="text-2xl font-bold" id="users-count">‚Äî</div>
                <div class="muted text-xs" id="users-active">Active: ‚Äî</div>
              </div>

              <div class="grid grid-cols-2 gap-2 mt-3">
                <div class="glass p-3 rounded-lg text-center">
                  <div class="muted text-xs">Vyom Areas</div>
                  <div id="vyom-area" class="font-semibold">‚Äî</div>
                </div>
                <div class="glass p-3 rounded-lg text-center">
                  <div class="muted text-xs">Devices</div>
                  <div id="devices" class="font-semibold">‚Äî</div>
                </div>
              </div>

              <div class="mt-4 space-y-2">
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://agridoot.com/"
                  >üåê AgriDoot</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://tiler.agridoot.in/"
                  >üõ∞Ô∏è Vyom Tiler</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://plans.agridoot.in/"
                  >üíµ Vyom - Price Calculator</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://media.agridoot.in/"
                  >üóÑÔ∏è Media Manager</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://notify.agridoot.co.in:9443/"
                  >üêô Notify System</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://vyom.agridoot.co.in/html/sign-up.html"
                  >üåø Vyom Dashboard</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://sales.agridoot.in/"
                  >üìà Sales & TeleCalling</a
                >
                <a
                  class="block glass p-2 rounded-lg text-sm hover:translate-x-1 transition"
                  href="https://iot.agridoot.in/"
                  >üé¥ IoT Registration</a
                >
              </div>
            </div>
          </aside>

          <!-- Right column: large panels -->
          <main class="lg:col-span-3 space-y-6">
            <!-- Summary cards row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="glass p-5 rounded-2xl">
                <div class="muted text-xs">Users</div>
                <div class="text-2xl font-bold" id="users-count-large">‚Äî</div>
                <div class="muted text-sm" id="users-active-large">
                  Active ‚Äî
                </div>
              </div>
              <div class="glass p-5 rounded-2xl">
                <div class="muted text-xs">Vyom</div>
                <div class="text-2xl font-bold" id="vyom-count">‚Äî</div>
                <div class="muted text-sm">
                  Area - <span id="vyom-area-large">‚Äî</span> acres
                </div>
              </div>
              <div class="glass p-5 rounded-2xl">
                <div class="muted text-xs">Gyan Queries</div>
                <div class="text-2xl font-bold" id="gyan-queries">‚Äî</div>
                <div class="muted text-sm">Realtime assistance</div>
              </div>
            </div>

            <!-- Charts area -->
            <div class="glass p-4 rounded-2xl">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">User Growth</h3>
                <div class="flex items-center gap-2">
                  <select
                    id="period"
                    class="bg-transparent border border-white/6 rounded px-3 py-1 text-sm"
                    onchange="fetchUserCounts()"
                  >
                    <option value="last_7_days">Last 7 days</option>
                    <option value="this_month" selected>This month</option>
                    <option value="last_month">Last month</option>
                    <option value="last_6_months">Last 6 months</option>
                    <option value="last_1_year">1 year</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
              <div class="space-y-4">
                <div class="p-2 glass rounded-lg">
                  <canvas id="userDateChart" height="160"></canvas>
                </div>
                <div class="p-2 glass rounded-lg">
                  <canvas id="userRegionChart" height="160"></canvas>
                </div>
              </div>
            </div>

            <!-- Analytics Table -->
            <div class="glass p-4 rounded-2xl">
              <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3"
              >
                <h3 class="font-semibold">Analytics</h3>
                <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
                  <select
                    id="user-type"
                    class="flex-1 md:flex-none bg-transparent border border-white/6 rounded px-3 py-1 text-sm min-w-[120px]"
                  >
                    <option value="all">All</option>
                    <option value="paid">Paid</option>
                    <option value="non-paid">Non-Paid</option>
                    <option value="non-farm">Non-Farm</option>
                  </select>
                  <input
                    id="search"
                    placeholder="Search..."
                    class="flex-1 md:flex-none bg-transparent border border-white/6 rounded px-3 py-1 text-sm min-w-[160px]"
                  />
                  <button
                    onclick="fetchAnalytics(1)"
                    class="btn-primary text-sm rounded px-4 py-1 w-full md:w-auto"
                  >
                    Show
                  </button>
                </div>
              </div>

              <div class="overflow-auto">
                <table class="w-full text-left data-table">
                  <thead id="table-headers" class="text-xs"></thead>
                  <tbody id="user-table" class="text-sm"></tbody>
                </table>
              </div>

              <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4"
              >
                <div class="muted text-sm">
                  Page <span id="page-num">1</span>
                </div>
                <div class="flex gap-2">
                  <button
                    onclick="prevPage()"
                    class="px-3 py-1 rounded bg-white/3"
                  >
                    Prev
                  </button>
                  <button
                    onclick="nextPage()"
                    class="px-3 py-1 rounded btn-primary"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>

            <footer class="text-sm muted text-center">
              AgriDoot ‚Äî By NovosEdge ¬© 2024
            </footer>
          </main>
        </div>
      </div>
    </div>

    <!-- Modal: Session expired -->
    <div
      id="session-modal"
      class="fixed inset-0 hidden items-center justify-center z-50"
    >
      <div class="bg-black/60 absolute inset-0"></div>
      <div class="glass p-6 rounded-2xl z-60 max-w-md mx-auto">
        <h3 class="text-lg font-semibold">Session expired</h3>
        <p class="muted mt-2">
          Please sign in again to continue using the dashboard.
        </p>
        <div class="mt-4 flex justify-end">
          <button onclick="closeModal()" class="px-4 py-2 rounded bg-white/5">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script>
      // Lightweight helpers
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      let whitelist = [];
      let logoutTimer;
      let currentPage = 1;

      // initial load: safe-fail if config not present
      fetch("config.json")
        .then((r) => r.json())
        .then((data) => {
          whitelist = data.whitelist || [];
          checkExistingLogin();
        })
        .catch(() => {
          console.warn("config.json not found or invalid");
        });

      function handleCredentialResponse(response) {
        try {
          const data = parseJwt(response.credential);
          const email = data.email;
          if (whitelist.includes(email)) {
            const loginData = { email, timestamp: Date.now() };
            localStorage.setItem("agridoot_user", JSON.stringify(loginData));
            showDashboard();
          } else {
            alert(
              "‚ùå Access Denied: " +
                email +
                " is not authorized. Contact Admin."
            );
          }
        } catch (e) {
          console.error(e);
          alert("Login failed");
        }
      }

      function parseJwt(token) {
        const base64Url = token.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
            .join("")
        );
        return JSON.parse(jsonPayload);
      }

      function checkExistingLogin() {
        const saved = localStorage.getItem("agridoot_user");
        if (!saved) return;
        try {
          const d = JSON.parse(saved);
          const now = Date.now();
          const sessionLimit = 12 * 60 * 60 * 1000;
          if (whitelist.includes(d.email) && now - d.timestamp < sessionLimit) {
            showDashboard(sessionLimit - (now - d.timestamp));
          } else {
            logout();
          }
        } catch (e) {
          logout();
        }
      }

      function showDashboard(remainingTime = 30 * 60 * 1000) {
        // hide auth screen and reveal protected app
        document.getElementById("auth-screen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");

        // fetch live info only after authenticated
        fetchPing();
        fetchSummary();
        fetchUserCounts();
        if (logoutTimer) clearTimeout(logoutTimer);
        logoutTimer = setTimeout(() => {
          openModal();
          logout();
        }, remainingTime);
      }

      function logout() {
        localStorage.removeItem("agridoot_user");
        document.getElementById("app").classList.add("hidden");
        document.getElementById("auth-screen").classList.remove("hidden");
      }

      function openModal() {
        document.getElementById("session-modal").classList.remove("hidden");
        document.getElementById("session-modal").classList.add("flex");
      }
      function closeModal() {
        document.getElementById("session-modal").classList.add("hidden");
        document.getElementById("session-modal").classList.remove("flex");
      }

      // Fetching endpoints with safe fallbacks
      function fetchPing() {
        fetch("https://apiv2.agridoot.co.in:12443/ping")
          .then((r) => r.json())
          .then((data) => {
            $("#status-pill").textContent = data.status || "‚Äî";
            $("#status-pill").className =
              data.status === "ok"
                ? "text-green-400 font-bold"
                : "text-red-400 font-bold";
            $("#uptime-pill").textContent = data.uptime || "‚Äî";
            $("#mode-top").textContent = data.mode || "‚Äî";
            document.getElementById("mode-top").textContent = data.mode || "‚Äî";
          })
          .catch((err) => {
            console.warn("ping failed", err);
            $("#status-pill").textContent = "unreachable";
            $("#status-pill").className = "text-red-400 font-bold";
          });
      }

      function fetchSummary() {
        fetch("https://api.novosedge.xyz:4433/ad/live")
          .then((r) => r.json())
          .then((data) => {
            const s = data.summary || {};
            $("#users-count").textContent = s.userCnt ?? "‚Äî";
            $("#users-count-large").textContent = s.userCnt ?? "‚Äî";
            $("#users-active").textContent = "Active: " + (s.userActive ?? "‚Äî");
            $("#users-active-large").textContent =
              "Active " + (s.userActive ?? "‚Äî");
            $("#vyom-count").textContent = s.vyomCnt ?? "‚Äî";
            $("#vyom-area").textContent = s.vyomArea ?? "‚Äî";
            $("#vyom-area-large").textContent = s.vyomArea ?? "‚Äî";
            $("#gyan-queries").textContent = s.gyanQue ?? "‚Äî";
            $("#devices").textContent = s.devCnt ?? "‚Äî";
          })
          .catch((e) => console.warn("summary fetch failed", e));
      }

      // Charts
      let dateChart, regionChart;
      function fetchUserCounts() {
        const period = document.getElementById("period").value;
        fetch(`https://api.novosedge.xyz:4433/ad/counts?period=${period}`)
          .then((r) => (r.ok ? r.json() : Promise.reject(r.statusText)))
          .then((data) => {
            if (!data.infoUser) return;
            const dates = data.infoUser.infoCnt
              .map((d) => new Date(d.day).toLocaleDateString())
              .reverse();
            const counts = data.infoUser.infoCnt
              .map((d) => d.user_count)
              .reverse();

            if (dateChart) dateChart.destroy();
            dateChart = new Chart($("#userDateChart"), {
              type: "line",
              data: {
                labels: dates,
                datasets: [
                  { label: "Users", data: counts, tension: 0.3, fill: true },
                ],
              },
              options: { plugins: { legend: { display: false } } },
            });

            const regions = data.infoUser.infoRegion.map((r) => r.region);
            const regionCounts = data.infoUser.infoRegion.map(
              (r) => r.user_count
            );
            if (regionChart) regionChart.destroy();
            regionChart = new Chart($("#userRegionChart"), {
              type: "bar",
              data: {
                labels: regions,
                datasets: [
                  { label: "Users", data: regionCounts, barThickness: 18 },
                ],
              },
              options: {
                indexAxis: "y",
                plugins: { legend: { display: false } },
              },
            });
          })
          .catch((e) => {
            console.warn("counts fetch failed", e);
          });
      }

      // Analytics table
      function fetchAnalytics(page = 1) {
        currentPage = page;
        document.getElementById("page-num").textContent = page;
        const type = $("#user-type").value;
        const search = encodeURIComponent($("#search").value || "");
        fetch(
          `https://api.novosedge.xyz:4433/ad/analytics?type=${type}&page=${page}&search=${search}`
        )
          .then((r) => (r.ok ? r.json() : Promise.reject(r.statusText)))
          .then((data) => {
            const table = $("#user-table");
            table.innerHTML = "";
            if (!data.userStats || !data.userStats.length) {
              $("#table-headers").innerHTML = "";
              return;
            }
            const headers = Object.keys(data.userStats[0]);
            $("#table-headers").innerHTML = `<tr>${headers
              .map((h) => `<th class='px-4 py-3'>${h}</th>`)
              .join("")}</tr>`;
            data.userStats.forEach((row) => {
              const tr = document.createElement("tr");
              headers.forEach((h) => {
                const td = document.createElement("td");
                td.className = "px-4 py-3 border-t border-white/6";
                td.textContent = row[h] ?? "-";
                tr.appendChild(td);
              });
              table.appendChild(tr);
            });
          })
          .catch((e) => console.warn("analytics fetch failed", e));
      }

      function nextPage() {
        fetchAnalytics(currentPage + 1);
      }
      function prevPage() {
        if (currentPage > 1) fetchAnalytics(currentPage - 1);
      }

      // initialize: do NOT fetch protected data until authenticated
      document.addEventListener("DOMContentLoaded", () => {
        // nothing here by design ‚Äî content is protected until login
      });

      // Logout button
      document.getElementById("logout-btn").addEventListener("click", () => {
        logout();
        alert("Logged out");
      });
    </script>
  </body>
</html>
